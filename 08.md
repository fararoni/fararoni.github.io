# Ejercicio 8.

## 8.1 Definini√≥n del esquema


### 1. Clonar el repositorio
En el directorio c:\sc, clonar el repositorio de inicio de la aplicaci√≥n:
```bash
cd c:\sc
git clone https://github.com/fararoni/curso.graphql.odyssey-lift-off-part1.git
```
### 2. Ejecutar la aplicaci√≥n de lado del servidor
En una ventana CMD, ir al directorio
```bash
cd c:\sc\curso.graphql.odyssey-lift-off-part1\server
```
Ejecute los siguientes comandos para instalar las dependencias y ejecutar la aplicaci√≥n:
```bash
npm install
npm start
```
√∫nicamente ver√° un mensaje final ‚Äúnodemon‚Äù

### 3. Ejecutar la aplicaci√≥n de lado del cliente

En otra  ventana CMD, ir al directorio

```bash
cmd
cd C:\sc\curso.graphql.odyssey-lift-off-part1\client
```

Ejecute los siguientes comandos para instalar las dependencias y ejecutar la aplicaci√≥n:
```bash
npm install
npm start
```

Abra el navegador e ingrese a la siguiente direcci√≥n:
```bash
http://127.0.0.1:3000/
```

### 4. Analisis de datos
Seg√∫n la maqueta, parece que necesitaremos la siguiente informaci√≥n para cada Ruta de aprendizaje:
- T√≠tulo
- Imagen en miniatura
- Duraci√≥n (duraci√≥n estimada)
- Recuento de m√≥dulos
- Nombre del autor
- Foto del autor

Un tipo se declara usando la palabra reservada type, seguida del nombre del tipo (la mejor pr√°ctica es usar un formatpo PascalCase y luego abrimos corchetes para contener los campos:
```graphql
type SpaceCat {
  # Los campos van aqu√≠
}
```
Quedando as√≠
```graphql
type SpaceCat {
  age: Int
  missions: [Mission]
}
```

Define un objeto tipo SpaceCat con los siguientes campos: name de tipo String(no nulo), age de tipo Int y missions de tipo List de Mission.
```graphql
type SpaceCat  {
  name: String!
  age: Int
  missions : [Mission]
}
```
Documenta tu esquema como mejor pr√°ctica y para permitir que herramientas como Apollo Studio Explorer orienten  a los usuarios a entender lo que hace su c√≥digo.
```graphql
type SpaceCat  {
  name: String!
  age: Int
  missions : [Mission]
}
```

### 5. Definici√≥n del esquema
Abrir una ventana CMD, ir al directorio del server  y abrir Visual Studio code
```bash
cmd
cd C:\sc\curso.graphql.odyssey-lift-off-part1\server
code .
```
- Crear un nuevo archivo en la carpeta ‚Äúsrc‚Äù con el nombre ‚Äúschema.js‚Äù.
- Desde visual estudio abrir una consola en el directorio server, asegurarse que sea de tipo CMD, ejecutar lo siguiente:
```bash
npm install @apollo/server graphql graphql-tag
```
Ahora en el archivo schema.js, cargar la plantilla literal gql de graphql-tag:
```javascript
const gql = require("graphql-tag");
```

Declarar una constante typeDefs (abreviatura de "definiciones de tipo"), a la que se le asignar√° la plantilla gql donde ir√°n nuestras definiciones
```javascript
const typeDefs = gql`
# Schema definitions go here

`;

module.exports = typeDefs;
```

Agregar el tipo Track
```javascript
const typeDefs = gql`
"Un Track es un grupo de m√≥dulos que ense√±an acerca de un t√≥pico"
type Track {
	id: ID!
	title: String!
	author: Author!
	thumbnail: String
	length: Int
	modulesCount: Int
	}
`;
```
Agregar el tipo Author
```javascript
const typeDefs = gql`
"Un Track es un grupo de m√≥dulos que ense√±an acerca de un t√≥pico"
type Track {
	id: ID!
	title: String!
	author: Author!
	thumbnail: String
	length: Int
	modulesCount: Int
	}
	"Autor de un Track completo o de un M√≥dulo "
	type Author {
		id: ID!
		name: String!
		photo: String
	}
`;
```
### 6. Definici√≥n de la consulta en el esquema

Obtener la lista de rutas (Tracks) para nuestra p√°gina de inicio
```javascript
type Query {
  " Obtener una lista de rutas para la cuadr√≠cula de la p√°gina de inicio"
  tracksForHome: [Track!]!
}
```
### 7. Version completa del archivo schema.js

```javascript
const gql = require("graphql-tag");
const typeDefs = gql`
type Query {
    "Obtener un arreglo de Tracks para la p√°gina de inicio"
    tracksForHome: [Track!]!
  }

"Un Track es un grupo de m√≥dulos que ense√±an acerca de un t√≥pico"
type Track {
	id: ID!
	title: String!
	author: Author!
	thumbnail: String
	length: Int
	modulesCount: Int
	}
	"Autor de un Track completo o de un M√≥dulo "
	type Author {
		id: ID!
		name: String!
		photo: String
	}
`;
module.exports = typeDefs;
```

## 8.2 Creaci√≥n del backend

### 1. Importar las librer√≠as del servidor
Desde Visual Studio code, en la carpeta  server/src/, abra el archivo index.js.
Agregar al principio
```javascript
const { ApolloServer } = require("@apollo/server");
const { startStandaloneServer } = require("@apollo/server/standalone");
const typeDefs = require("./schema");
```
Configuremos una funci√≥n async llamada startApolloServer, para crear una instancia de la clase ApolloServer y le pasaremos nuestro objeto typeDefs en sus par√°metros de objetos

```javascript
async function startApolloServer() {
	const server = new ApolloServer({ typeDefs });
}
```

> Nota: En este c√≥digo estamos usando la notaci√≥n de propiedad abreviada
> con claves impl√≠citas, porque hemos nombrado nuestra constante que
> coincide con su atributo correspondiente ( typeDefs).

Para iniciar el servidor, usaremos la funci√≥n startStandaloneServer, pas√°ndola al server que acabamos de inicializar.
```javascript
async  function  startApolloServer() {
	const  server  =  new  ApolloServer({ typeDefs });
	startStandaloneServer(server);
}
```

La funci√≥n startStandaloneServer devuelve una Promise, por lo que esperaremos los await de esa llamada y extraeremos la propiedad url del resultado.
```javascript
async function startApolloServer() {
	const server = new ApolloServer({ typeDefs });
	const { url } = await startStandaloneServer(server);
}
```

Agregar un mensaje que indique que ya se levant√≥ el servidor
```javascript
async function startApolloServer() {
  const server = new ApolloServer({ typeDefs });
  const { url } = await startStandaloneServer(server);
  console.log(`
    üöÄ  Server is running!
    üì≠  Query at ${url}
  `);
}

```
Finalmente, llamar a la startApolloServerfunci√≥n al final del archivo.
```javascript
startApolloServer();
```
Comparar la versi√≥n completa
```javascript
const { ApolloServer } = require("@apollo/server");
const { startStandaloneServer } = require("@apollo/server/standalone");
const typeDefs = require("./schema");

async function startApolloServer() {
    const server = new ApolloServer({ typeDefs });
    const { url } = await startStandaloneServer(server);
    console.log(`
      üöÄ  Server is running!
      üì≠  Query at ${url}
    `);
  }
  
  startApolloServer();
```
Levantar el servidor
Desde la terminal, iniciaremos nuestro servidor con npm run start desde la carpeta server

```bash
npm start
```
### 2. Sandbox explorer
- Navegar en los apartados del explorar de Apollo

### 3 Consultas

Guardar una operaci√≥n con el nombre GetTracks que nos va a servir posteriormente.

### 4 Datos mock
El explorador no puede entregar datos porque no los tiene, vamos a generar datos simulados.
En la consola de visual studio, interrumpir la ejecuci√≥n del servidor y agregar las siguientes paquetes

```bash
ctrl + c
npm install @graphql-tools/mock @graphql-tools/schema
```
Agregar al principio del archivo index.js
```javascript
const { addMocksToSchema } = require("@graphql-tools/mock"); const { makeExecutableSchema } = require("@graphql-tools/schema");
```
Modificar la constante server para que reciba los datos mock
```javascript
const server = new ApolloServer({
  schema: addMocksToSchema({
    schema: makeExecutableSchema({ typeDefs }),
  }),
});
```
Levanta nuevamente el servidor y revisa los datos en el explorador

Para que no muestre datos tan gen√©ricos, agregar lo siguiente debajo de la l√≠nea 
```javascript
const  typeDefs  =  require("./schema");
```

```javascript
const mocks = {
  Track: () => ({
    id: () => "track_01",
    title: () => "Astro Kitty, Space Explorer",
    author: () => {
      return {
        name: "Grumpy Cat",
        photo:
          "https://res.cloudinary.com/dety84pbu/image/upload/v1606816219/kitty-veyron-sm_mctf3c.jpg",
      };
    },
    thumbnail: () =>
      "https://res.cloudinary.com/dety84pbu/image/upload/v1598465568/nebula_cat_djkt9r.jpg",
    length: () => 1210,
    modulesCount: () => 6,
  }),
};
```

Y modificar la invocaci√≥n del server
```javascript
const server = new ApolloServer({
  schema: addMocksToSchema({
    schema: makeExecutableSchema({ typeDefs }),
    mocks,
  }),
});
```

## 8.3 Frontend

### 1. Abrir el proyecto frontend react

Abrir una Ventana CMD, ir al directorio C:\sc\curso.graphql.odyssey-lift-off-part1\client y abrir Visual Studio Code:.
```bash
	cmd
	cd C:\sc\curso.graphql.odyssey-lift-off-part1\client
	code .
```
Desde visual studio, abrir una terminal CMD y ejecutar
```bash
	npm start
```
Abrir el archivo ra√≠z de nuestra aplicaci√≥n React (client/src/index.js) , debe verse de la siguiente forma
```javascript
import React from 'react';
import { createRoot } from 'react-dom/client'
import GlobalStyles from './styles';
import Pages from './pages';

const root = createRoot(document.getElementById('root'));

root.render(
  <React.StrictMode>
    <GlobalStyles />
    <Pages />
  </React.StrictMode>
);
```
Interrumpa la ejecuci√≥n del cliente y ejecute el siguiente comando
```bash
C:\sc\curso.graphql.odyssey-lift-off-part1\client>npm install graphql @apollo/client
```
### Imporar ApolloClient en el frontend
Importar en src/index.js los tres s√≠mbolos que necesitamos del paquete @apollo/client

```javascript
import { ApolloClient, InMemoryCache, ApolloProvider } from "@apollo/client";
```
Crear uns instancia de ApolloClient

```javascript
const client = new ApolloClient({
  uri: "http://localhost:4000",
  cache: new InMemoryCache(),
});
```
### Hacer que Apollo Client quede disponible para todo el arbol de componentes de React

```javascript
root.render(
  <React.StrictMode>
    <ApolloProvider client={client}>
      <GlobalStyles />
      <Pages />
    </ApolloProvider>
  </React.StrictMode>
);
```
Reiniciar el client

```bash
npm start
```
Se  ve igual, porque aun no se le envia una consulta

### Enviar query
Abrir C:\sc\curso.graphql.odyssey-lift-off-part1\client\src\pages\tracks.js e importar la plantilla gql al principio del archivo

```javascript
import { gql } from "@apollo/client";
```
A continuaci√≥n definir la consulta TRACKS
```javascript
const TRACKS = gql`
  # Query goes here
`;
```

Abrir el explorador en el server y recuperar la consulta guardada TracksForHome.
Actualizar con la consulta

```javascript
const TRACKS = gql`
  query GetTracks {
    tracksForHome {
      id
      title
      thumbnail
      length
      modulesCount
      author {
        id
        name
        photo
      }
    }
  }
`;
```
### hook  useQuery

Importar useQuery desde el paquete @apollo/client  en src/pages/tracks.js.

```javascript
import { useQuery, gql } from "@apollo/client";
```
Y en el componente Tracks las siguientes constantes desestructuradas
```javascript
 const Tracks = () => {
  const { loading, error, data } = useQuery(TRACKS);
  if (loading) return "Loading...";
  if (error) return `Error! ${error.message}`;
  return <Layout grid>{JSON.stringify(data)}</Layout>;
};
```

Actualiza el servidor, debe mostrar datos. Aunque no est√°n amigables
El c√≥digo queda de la siguiente forma

```javascript
import React from 'react';
import { Layout } from '../components';
import { useQuery, gql } from "@apollo/client";

const TRACKS = gql`
  query GetTracks {
    tracksForHome {
      id
      title
      thumbnail
      length
      modulesCount
      author {
        id
        name
        photo
      }
    }
  }
`;

/**
 * Tracks Page is the Catstronauts home page.
 * We display a grid of tracks fetched with useQuery with the TRACKS query
 */
const Tracks = () => {
  const { loading, error, data } = useQuery(TRACKS);
  if (loading) return "Loading...";
  if (error) return `Error! ${error.message}`;
  return <Layout grid>{JSON.stringify(data)}</Layout>;

};
export default Tracks;
```

### Renderizado en las tarjetas

Continuar trabajando en src/pages/tracks.js
```javascript
import TrackCard from  "../containers/track-card";
```
Actualizar la siguiente l√≠nea
```javascript
 return <Layout grid>{JSON.stringify(data)}</Layout>;
```
Por la siguiente
```javascript
return <Layout grid>
  {data?.tracksForHome?.map((track) => (
    <TrackCard key={track.id} track={track} />
  ))}
</Layout>
```

### Manejo de los resultados
Continuar trabajando en src/pages/tracks.js
```javascript
import QueryResult from "../components/query-result";
```
Actualizar la siguiente l√≠nea
```javascript
	if (loading) return "Loading...";
	if (error) return `Error! ${error.message}`;
```
Por lo siguiente
```javascript
<QueryResult error={error} loading={loading} data={data}>
  {data?.tracksForHome?.map((track) => (
    <TrackCard key={track.id} track={track} />
  ))}
</QueryResult>
```

### Actualice el navegador y compruebe la salida
```bash
	npm start
```
